[ ![小媛在努力](https://farm4.staticflickr.com/3878/14293872807_5d75ce918e_o.png)
](http://www.xysay.com/) _ hi hi bye bye~ _ SEARCH

![小媛在努力](https://farm3.staticflickr.com/2923/14479005692_29a98a69a0_o.jpg)

网站导航

  * [ Home ](http://xysay.com)
  * [ About Me ](http://www.xysay.com/about-me)

_ _ [ 首页 ](http://www.xysay.com) > [ Linux
](http://www.xysay.com/category/linux%e5%ad%a6%e4%b9%a0) > [读书笔记] 网络模块初始化

2014  
10-10

#  [读书笔记] 网络模块初始化

_ _ [ zxy_snow ](http://www.xysay.com/author/zxy_snow) _ _ [ Linux
](http://www.xysay.com/category/linux%e5%ad%a6%e4%b9%a0) , [ 学习笔记
](http://www.xysay.com/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0) _ _ 围观 _
313 _ 次  _ _ [ 4 条评论 ](http://www.xysay.com/net-module-init.html#comments) _ _
编辑日期：  2014-10-10  _ _ 字体： [ 大 ](javascript:;) [ 中 ](javascript:;) [ 小
](javascript:;)

读《Linux 内核源码剖析- TCP/IP 实现》第四章笔记。
此书用的是2.6.20的内核，我在看的同时对比了3.14.17的内核源码，所以内容有变动，都是基于3.14.17内核源码。  
有关网络的初始化过程主要由sysctl_init()和do_initcalls()完成。其中系统调用sysctl_init()是在start_kernel(
) ->proc_root_init()->proc_sys_init()->sysctl_init()。完成sysctl的初始化注册过程。后者进行了一系列
的初始化模块：

static char *initcall_level_names[] __initdata = { "early", "core",
"postcore", "arch", "subsys", "fs", "device", "late", }; static void __init
do_initcalls(void) { int level; for (level = 0; level <
ARRAY_SIZE(initcall_levels) - 1; level++) do_initcall_level(level); }

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

17

|

static  char  *  initcall_level_names  [  ]  __initdata  =  {

"early"  ,

"core"  ,

"postcore"  ,

"arch"  ,

"subsys"  ,

"fs"  ,

"device"  ,

"late"  ,

}  ;

static  void  __init  do_initcalls  (  void  )

{

int  level  ;

for  (  level  =  0  ;  level  < ARRAY_SIZE  (  initcall_levels  )  \-  1  ;
level  ++  )

do_initcall_level  (  level  )  ;

}  
  
---|---  
  
对模块的初始化，一般是通过module_init宏来登记初始化函数。对于静态编译到内核中的驱动程序模块，module_init宏指示编译器把模块的入口函数放
到一个特殊的段中，在内核初始化过程中，由do_initcalls()调用这些函数从而达到初始化的效果。Module_init宏定义在include/linu
x/init.h中

typedef int (*initcall_t)(void); … #define __define_initcall(fn, id) \ static
initcall_t __initcall_##fn##id __used \ __attribute__((__section__(".initcall"
#id ".init"))) = fn … #define device_initcall(fn) __define_initcall(fn, 6) …
#define __initcall(fn) device_initcall(fn) … #define module_init(x)
__initcall(x);

1

2

3

4

5

6

7

8

9

10

11

|

typedef  int  (  *  initcall_t  )  (  void  )  ;

…

#define __define_initcall(fn, id) \

static  initcall_t  __initcall_  ##fn##id __used \

__attribute__  (  (  __section__  (  ".initcall"  #id ".init"))) = fn

…

#define device_initcall(fn) __define_initcall(fn, 6)

…

#define __initcall(fn) device_initcall(fn)

…

#define module_init(x) __initcall(x);  
  
---|---  
  
其中INITCALLS定义在vmlinux.lds.h (include\asm-generic)

#define INIT_CALLS_LEVEL(level) \ VMLINUX_SYMBOL(__initcall##level##_start) =
.; \ *(.initcall##level##.init) \ *(.initcall##level##s.init) \ #define
INIT_CALLS \ VMLINUX_SYMBOL(__initcall_start) = .; \ *(.initcallearly.init) \
INIT_CALLS_LEVEL(0) \ INIT_CALLS_LEVEL(1) \ INIT_CALLS_LEVEL(2) \
INIT_CALLS_LEVEL(3) \ INIT_CALLS_LEVEL(4) \ INIT_CALLS_LEVEL(5) \
INIT_CALLS_LEVEL(rootfs) \ INIT_CALLS_LEVEL(6) \ INIT_CALLS_LEVEL(7) \
VMLINUX_SYMBOL(__initcall_end) = .;

1

2

3

4

5

6

7

8

9

10

11

12

13

14

15

16

17

18

|

#define INIT_CALLS_LEVEL(level) \

VMLINUX_SYMBOL  (  __initcall  ##level##_start) = .; \

*  (  .  initcall  ##level##.init) \ 

*  (  .  initcall  ##level##s.init) \ 

#define INIT_CALLS \

VMLINUX_SYMBOL  (  __initcall_start  )  =  .  ;  \

*  (  .  initcallearly  .  init  )  \ 

INIT_CALLS_LEVEL  (  0  )  \

INIT_CALLS_LEVEL  (  1  )  \

INIT_CALLS_LEVEL  (  2  )  \

INIT_CALLS_LEVEL  (  3  )  \

INIT_CALLS_LEVEL  (  4  )  \

INIT_CALLS_LEVEL  (  5  )  \

INIT_CALLS_LEVEL  (  rootfs  )  \

INIT_CALLS_LEVEL  (  6  )  \

INIT_CALLS_LEVEL  (  7  )  \

VMLINUX_SYMBOL  (  __initcall_end  )  =  .  ;  
  
---|---  
  
__initcall_start和__initcall_end来记录.initcall.init的起始结束地址。这个我们可以在编译后的vmlinux.lds
中看到：

:init .init.data : AT(ADDR(.init.data) - 0xffffffff80000000) { *(.init.data) .
= ALIGN(8); __start_mcount_loc = .; *(__mcount_loc) __stop_mcount_loc = .;
*(.init.rodata) . = ALIGN(8); __start_ftrace_events = .; *(_ftrace_events)
__stop_ftrace_events = .; . = ALIGN(8); __start_syscalls_metadata = .;
*(__syscalls_metadata) __stop_syscalls_metadata = .; . = ALIGN(8);
__clk_of_table = .; *(__clk_of_table) *(__clk_of_table_end) . = ALIGN(32);
__dtb_start = .; *(.dtb.init.rodata) __dtb_end = .; . = ALIGN(16);
__setup_start = .; *(.init.setup) __setup_end = .; __initcall_start = .;
*(.initcallearly.init) __initcall0_start = .; *(.initcall0.init)
*(.initcall0s.init) __initcall1_start = .; *(.initcall1.init)
*(.initcall1s.init) __initcall2_start = .; *(.initcall2.init)
*(.initcall2s.init) __initcall3_start = .; *(.initcall3.init)
*(.initcall3s.init) __initcall4_start = .; *(.initcall4.init)
*(.initcall4s.init) __initcall5_start = .; *(.initcall5.init)
*(.initcall5s.init) __initcallrootfs_start = .; *(.initcallrootfs.init)
*(.initcallrootfss.init) __initcall6_start = .; *(.initcall6.init)
*(.initcall6s.init) __initcall7_start = .; *(.initcall7.init)
*(.initcall7s.init) __initcall_end = .; __con_initcall_start = .;
*(.con_initcall.init) __con_initcall_end = .; __security_initcall_start = .;
*(.security_initcall.init) __security_initcall_end = .; . = ALIGN(4);
__initramfs_start = .; *(.init.ramfs) . = ALIGN(8); *(.init.ramfs.info) }

1

2

|

:  init

.  init  .  data  :  AT  (  ADDR  (  .  init  .  data  )  \-
0xffffffff80000000  )  {  *  (  .  init  .  data  )  .  =  ALIGN  (  8  )  ;
__start_mcount_loc  =  .  ;  *  (  __mcount_loc  )  __stop_mcount_loc  =  .  ;
*  (  .  init  .  rodata  )  .  =  ALIGN  (  8  )  ;  __start_ftrace_events  =
.  ;  *  (  _ftrace_events  )  __stop_ftrace_events  =  .  ;  .  =  ALIGN  (
8  )  ;  __start_syscalls_metadata  =  .  ;  *  (  __syscalls_metadata  )
__stop_syscalls_metadata  =  .  ;  .  =  ALIGN  (  8  )  ;  __clk_of_table  =
.  ;  *  (  __clk_of_table  )  *  (  __clk_of_table_end  )  .  =  ALIGN  (  32
)  ;  __dtb_start  =  .  ;  *  (  .  dtb  .  init  .  rodata  )  __dtb_end  =
.  ;  .  =  ALIGN  (  16  )  ;  __setup_start  =  .  ;  *  (  .  init  .
setup  )  __setup_end  =  .  ;  __initcall_start  =  .  ;  *  (  .
initcallearly  .  init  )  __initcall0_start  =  .  ;  *  (  .  initcall0  .
init  )  *  (  .  initcall0s  .  init  )  __initcall1_start  =  .  ;  *  (  .
initcall1  .  init  )  *  (  .  initcall1s  .  init  )  __initcall2_start  =
.  ;  *  (  .  initcall2  .  init  )  *  (  .  initcall2s  .  init  )
__initcall3_start  =  .  ;  *  (  .  initcall3  .  init  )  *  (  .
initcall3s  .  init  )  __initcall4_start  =  .  ;  *  (  .  initcall4  .
init  )  *  (  .  initcall4s  .  init  )  __initcall5_start  =  .  ;  *  (  .
initcall5  .  init  )  *  (  .  initcall5s  .  init  )  __initcallrootfs_start
=  .  ;  *  (  .  initcallrootfs  .  init  )  *  (  .  initcallrootfss  .
init  )  __initcall6_start  =  .  ;  *  (  .  initcall6  .  init  )  *  (  .
initcall6s  .  init  )  __initcall7_start  =  .  ;  *  (  .  initcall7  .
init  )  *  (  .  initcall7s  .  init  )  __initcall_end  =  .  ;
__con_initcall_start  =  .  ;  *  (  .  con_initcall  .  init  )
__con_initcall_end  =  .  ;  __security_initcall_start  =  .  ;  *  (  .
security_initcall  .  init  )  __security_initcall_end  =  .  ;  .  =  ALIGN
(  4  )  ;  __initramfs_start  =  .  ;  *  (  .  init  .  ramfs  )  .  =
ALIGN  (  8  )  ;  *  (  .  init  .  ramfs  .  info  )  }  
  
---|---  
  
定义模块加载函数的宏module_init被定义在include/linux/init.h中

/* Each module must use one module_init(). */ #define module_init(initfn) \
static inline initcall_t __inittest(void) \ { return initfn; } \ int
init_module(void) __attribute__((alias(#initfn)));

1

2

3

4

5

|

/* Each module must use one module_init(). */

#define module_init(initfn) \

static  inline  initcall_t  __inittest  (  void  )  \

{  return  initfn  ;  }  \

int  init_module  (  void  )  __attribute__  (  (  alias  (  #initfn)));  
  
---|---  
  
关于网络的一些初始化函数：

  * subsys_initcall(proto_init):套接口层的初始化函数 
  * fs_initcall(inet_init)：传输层的初始化函数 
  * subsys_initcall(net_dev_init)：Internet协议簇的初始化函数 
  * core_initcall(sock_init)：设备处理层的初始化函数 
  * module_init(e100_init_module)：e100型号的网络设备驱动的初始化函数 

其中sock_init(),proto_init(),inet_init()初始化函数涉及网络的三层、四层协议。

  * 本文固定链接: [ http://www.xysay.com/net-module-init.html ](http://www.xysay.com/net-module-init.html)
  * 转载请注明: [ zxy_snow ](http://www.xysay.com/author/zxy_snow) 2014年10月10日  于 [ 小媛在努力 ](http://www.xysay.com/) 发表 

最后编辑：  2014-10-10

** 作者：zxy_snow **

![](http://1.gravatar.com/avatar/390ba7fe743122e7d40c1b778d8777f1?s=96&d=ident
icon&r=G)

吃好，喝好，学习好！

[ _ _ 站内专栏 ](http://www.xysay.com?author=1) [ _ _ 站点 ](http://www.xysay.com)

_ _ [ linux ](http://www.xysay.com/tag/linux) ， [ 内核
](http://www.xysay.com/tag/%e5%86%85%e6%a0%b8) ， [ 网络协议栈
](http://www.xysay.com/tag/%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%e6%a0%88)

  

[ _ _ 14已过，15整装待发，准备启航 ](http://www.xysay.com/14-summary-15-outlook.html)

[ [读书笔记] sk_buff套接口缓存结构 _ _ ](http://www.xysay.com/sk-buff-struct.html)

###  _ _ 您可能还会对这些文章感兴趣！

  * [ [读书笔记] sk_buff套接口缓存结构 ](http://www.xysay.com/sk-buff-struct.html)
  * [ Linux socket编程学习笔记（一）：socket()函数详解 ](http://www.xysay.com/linux-socket-133.html)

  1. [ 左耳朵在听 ](http://weibo.com/3788272350) on [ 2014 年 10 月 10 日 at 18:01  ](http://www.xysay.com/net-module-init.html#comment-2414) said: 

沙发

  2. [ copylefter_ ](http://weibo.com/jixinzhang) on [ 2014 年 10 月 10 日 at 19:18  ](http://www.xysay.com/net-module-init.html#comment-2415) said: 

板凳了，瓜子拿起，前来围观。话说你看的好仔细呀，都把最新的拿出来比较了。我也好好干活去了，天天被你鄙视

    * [ 小媛在努力 ](http://weibo.com/orbital) on [ 2014 年 10 月 10 日 at 19:28  ](http://www.xysay.com/net-module-init.html#comment-2416) said: 

其实没几页，都拉拉杂杂看了一天，哎，效率不高

  3. [ 红豆殺 ](http://www.178-go.com/) on [ 2014 年 12 月 2 日 at 10:04  ](http://www.xysay.com/net-module-init.html#comment-2431) said: 

评论框头像转动功能不错哦～

  *   * ###  分类 

    * [ Life ](http://www.xysay.com/category/life) (9) 
    * [ Linux ](http://www.xysay.com/category/linux%e5%ad%a6%e4%b9%a0) (2) 
    * [ 写代码玩儿 ](http://www.xysay.com/category/%e5%86%99%e4%bb%a3%e7%a0%81%e7%8e%a9%e5%84%bf) (1) 
    * [ 学习笔记 ](http://www.xysay.com/category/%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0) (3) 
    * [ 推荐系统 ](http://www.xysay.com/category/%e6%8e%a8%e8%8d%90%e7%b3%bb%e7%bb%9f) (3) 
    * [ 论文笔记 ](http://www.xysay.com/category/%e8%ae%ba%e6%96%87%e7%ac%94%e8%ae%b0) (3) 
    * [ 题解 ](http://www.xysay.com/category/%e9%a2%98%e8%a7%a3) (1) 
  * ###  最近评论 

  * ###  近期文章 

    * [ 14已过，15整装待发，准备启航 ](http://www.xysay.com/14-summary-15-outlook.html)
    * [ [读书笔记] 网络模块初始化 ](http://www.xysay.com/net-module-init.html)
    * [ [读书笔记] sk_buff套接口缓存结构 ](http://www.xysay.com/sk-buff-struct.html)
    * [ [论文笔记] GroupLens: 一个基于协同过滤的新闻架构 ](http://www.xysay.com/grouplens-open-architecture-collaborative-filtering.html)
    * [ [论文笔记] 基于物品的协同过滤算法 ](http://www.xysay.com/item-based-collaborative-filtering-algorithms.html)
  * ###  友情链接 

    * [ cgangee@ZZU ](http://www.cgangee.com)
    * [ FOOKWOOD@阿里 ](http://www.fookwood.com)
    * [ IdleMind ](http://idlemind.sinaapp.com/)
    * [ LaiZhihua ](http://HelloACM.com)
    * [ Vgo@Darling ](http://zhangjixin.tk/)
    * [ 一起吧，GO! ](http://www.178-go.com/)
    * [ 刁瑞@Google ](http://diaorui.net/)
    * [ 我的CSDN博客 ](http://blog.csdn.net/zxy_snow)
    * [ 李奇@ZZU ](http://qilee.me/)
  * ###  文章归档 

    * [ 2015年一月 ](http://www.xysay.com/2015/01)
    * [ 2014年十月 ](http://www.xysay.com/2014/10)
    * [ 2014年七月 ](http://www.xysay.com/2014/07)
    * [ 2014年六月 ](http://www.xysay.com/2014/06)
    * [ 2013年四月 ](http://www.xysay.com/2013/04)
    * [ 2012年十一月 ](http://www.xysay.com/2012/11)
    * [ 2012年五月 ](http://www.xysay.com/2012/05)
    * [ 2012年三月 ](http://www.xysay.com/2012/03)
    * [ 2012年二月 ](http://www.xysay.com/2012/02)
    * [ 2012年一月 ](http://www.xysay.com/2012/01)
    * [ 2011年十二月 ](http://www.xysay.com/2011/12)
  * ###  Tags 

[ 碎碎念 (4) ](http://www.xysay.com/tag/%e7%a2%8e%e7%a2%8e%e5%bf%b5) [ linux (3)
](http://www.xysay.com/tag/linux) [ 计划 (3)
](http://www.xysay.com/tag/%e8%ae%a1%e5%88%92) [ 感想 (3)
](http://www.xysay.com/tag/%e6%84%9f%e6%83%b3) [ 协同过滤 (3)
](http://www.xysay.com/tag/%e5%8d%8f%e5%90%8c%e8%bf%87%e6%bb%a4) [ 推荐系统 (3)
](http://www.xysay.com/tag/%e6%8e%a8%e8%8d%90%e7%b3%bb%e7%bb%9f) [ 网络协议栈 (2)
](http://www.xysay.com/tag/%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%e6%a0%88) [
item-based (2) ](http://www.xysay.com/tag/item-based) [ ACM (2)
](http://www.xysay.com/tag/acm) [ 校赛 (2)
](http://www.xysay.com/tag/%e6%a0%a1%e8%b5%9b) [ 郑州大学 (2)
](http://www.xysay.com/tag/%e9%83%91%e5%b7%9e%e5%a4%a7%e5%ad%a6) [ 内核 (2)
](http://www.xysay.com/tag/%e5%86%85%e6%a0%b8) [ 考研 (1)
](http://www.xysay.com/tag/%e8%80%83%e7%a0%94) [ algorithm (1)
](http://www.xysay.com/tag/algorithm) [ GroupLens (1)
](http://www.xysay.com/tag/grouplens) [ 2014总结 (1)
](http://www.xysay.com/tag/2014%e6%80%bb%e7%bb%93) [ 2015展望 (1)
](http://www.xysay.com/tag/2015%e5%b1%95%e6%9c%9b) [ 亚马逊 (1)
](http://www.xysay.com/tag/%e4%ba%9a%e9%a9%ac%e9%80%8a) [ C++ (1)
](http://www.xysay.com/tag/c) [ 408 (1) ](http://www.xysay.com/tag/408) [ 中科院
(1) ](http://www.xysay.com/tag/%e4%b8%ad%e7%a7%91%e9%99%a2) [ socket (1)
](http://www.xysay.com/tag/socket) [ 算法 (1)
](http://www.xysay.com/tag/%e7%ae%97%e6%b3%95) [ 数据库 (1)
](http://www.xysay.com/tag/%e6%95%b0%e6%8d%ae%e5%ba%93)

[ 返回顶部 ](javascript:void\(0\)) [ 网站地图 ]() [ ](http://www.miitbeian.gov.cn/) ©
| Theme  frontopen2

[ ](javascript:void\(\)) [ ](http://www.xysay.com/wp-admin/) [
](javascript:void\(\))

