[ ![简言](/img/logo.png) ](/)

#  [ 简言 ](/)

##  言简意赅，技术远没那么复杂

    * [ Home ](/)
    * [ Archives ](/archives)
    * [ About ](/about)
    * Search 

#  [ Java 与 C++ 混合编程——JNI 学习小记 ](/2014/06/21/notes-on-java-and-c-programming-
jni-blended-learning/)

By [ 简言 ](https://plus.google.com/103441795113657293146?rel=author)

Published Jun 21 2014

** Contents **

  1. 1\.  缘起 
  2. 2\.  何谓JNI？ 
  3. 3\.  HelloWorld 
  4. 4\.  More 

##  缘起

最近对 [ OpenJDK源码 ](http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/cf44386c8fe3/s
rc/share/classes/java) 产生了很大的兴趣，而其中有较多的native方法，如 [ System.java ](http://hg.op
enjdk.java.net/jdk7/jdk7/jdk/file/cf44386c8fe3/src/share/classes/java/lang/Sys
tem.java) 中的arraycopy方法（第482行）、setOut0方法（第247行）等。Google一下后发现这是Java Native
Interface(JNI)，便花点时间学习了一下。

##  何谓JNI？

JNI是Java平台中的一个强大特性。  
应用程序可以通过JNI把C/C++代码集成进Java程序中，这样开发者在利用Java平台强大功能的同时，又不必放弃对原有代码的投资。

##  HelloWorld

闲话少说，先看代码：

新建一个class，名称为Algorithm

    
    
    1
    
    2
    
    3
    
    4
    
    5
    
    6
    
    7
    
    8
    
    9
    
    10
    
    11
    
    12

|

    
    
    public class Algorithm {
    
    	static {
    
    		System.loadLibrary("Hello");
    
    	}
    
    	public static native void write(String msg);
    
    	public static void main(String[] args) {
    
    		write("Hello, 混合编程！");
    
    	}
    
    }  
  
---|---  
  
保存。

打开cmd，cd到\src，执行 ` javah Algorithm `
（如果你的.java文件在某一package下的话，比如在\mjava\lang\里面，就执行 ` javah mjava.lang.Algorithm `
），生成 ` Algorithm.h ` 文件，如下：

    
    
    1
    
    2
    
    3
    
    4
    
    5
    
    6
    
    7
    
    8
    
    9
    
    10
    
    11
    
    12
    
    13
    
    14
    
    15
    
    16
    
    17
    
    18
    
    19
    
    20
    
    21

|

    
    
    /* DO NOT EDIT THIS FILE - it is machine generated */
    
    #include <jni.h>
    
    /* Header for class Algorithm */
    
    #ifndef _Included_Algorithm
    
    #define _Included_Algorithm
    
    #ifdef __cplusplus
    
    extern "C" {
    
    #endif
    
    /*
    
     * Class:     Algorithm
    
     * Method:    write
    
     * Signature: (Ljava/lang/String;)V
    
     */
    
    JNIEXPORT void JNICALL Java_Algorithm_write
    
      (JNIEnv *, jclass, jstring);
    
    #ifdef __cplusplus
    
    }
    
    #endif
    
    #endif  
  
---|---  
  
对于Windows下的JDK来说，可以在JDK目录 ` \include\win32\jni_md.h ` 中找到如下定义

    
    
    1
    
    2
    
    3

|

    
    
    #define JNIEXPORT __declspec(dllexport)
    
    #define JNIIMPORT __declspec(dllimport)
    
    #define JNICALL __stdcall  
  
---|---  
  
其中 ` __declspec ` 用于指定所给定类型的实例的与Microsoft相关的存储方式。  
` dllexport ` 用来从dll中导出函数，数据或对象， ` dllimport ` 用来从dll导入函数，数据，或对象。  
这相当于定义了dll的接口，提供可被Java使用的C/C++函数，数据，或对象。  
` __stdcall ` 见 [ 百度百科 ](http://baike.baidu.com/view/1276580.htm) 。  
` JNIEnv ` ， ` jclass ` 和 ` jstring ` 的定义见 ` \include\jni.h ` ，也可以参考 [ jni详解
](http://wenku.baidu.com/link?url=khOHgORmPEnOlIwZ_Zi7VBnueTNQcSp60EV-
Grmiw12bgrLt0YT9rxTQq8PeOiBVecVewsW54EIBdKIt_DogruJUeqHaoYO9rFy8vDWs9Ce) 。

随后打开VS2012，新建 Win32项目，名称随便：  
![](http://endless.qiniudn.com/blogjni01.png)  
应用程序类型选择DLL：  
![](http://endless.qiniudn.com/blogjni02.png)  
按 ` alt ` \+ ` F7 ` ，点击 ` 配置属性 ` \- ` VC++目录 `
，如果你的JDK是64位的话，你的VS2012也应该是64位，此时做如下修改：（32位可以无视）  
![](http://endless.qiniudn.com/blogjni05.png)  
然后点击 ` 包含目录 ` \- ` 编辑 ` ：  
![](http://endless.qiniudn.com/blogjni04.png)  
点击文件夹图标，把 ` \include\ ` ， ` \include\win32\ ` 和 ` Algorithm.h ` 所在目录加进去。  
随后点击 ` 常规 ` ，把 ` 配置类型 ` 改为 ` 动态库(.dll) ` 。

打开 ` <项目名>.cpp ` ，这里 ` <项目名> ` 是你自己输入的名字，输入如下代码：（函数名必须与Algorithm.h中声明的一致）

    
    
    1
    
    2
    
    3
    
    4
    
    5
    
    6
    
    7
    
    8
    
    9
    
    10
    
    11

|

    
    
    #include "stdafx.h"
    
    #include "Algorithm.h"
    
    #include <clocale>
    
    #include <cwchar>
    
    JNIEXPORT void JNICALL Java_Algorithm_write(JNIEnv * env, jclass obj, jstring jMsg)
    
    {
    
    	setlocale(LC_ALL, "Chinese-simplified"); // clocale
    
    	   wprintf(L"%ls", (wchar_t*)env->GetStringChars(jMsg, NULL));
    
    }  
  
---|---  
  
这里 ` setlocale ` 函数用来配置地域化信息， ` GetStringChars `
函数将jstring转化成jchar数组并返回jchar*，这里jchar被定义为unsigned short，所以可以转化成wchar_t类型。

按 ` F7 ` 。

在你的项目文件夹中找到 ` <项目名>.dll ` 文件，复制，粘贴到你的工程下（直接在Eclipse中单击工程名然后 ` ctrl ` \+ ` V `
），并重命名为 ` Hello.dll ` 。

回到Eclipse，按下 ` Ctrl ` \+ ` F11 ` ，Well done！  
![](http://endless.qiniudn.com/blogjni06.png)

##  More

自定义readLine()方法的实现，见 [ GitHub ](https://github.com/EndlessCheng/OpenJDK-
7u4-analysis)

[ 混合编程 ](/tags/混合编程/) [ JNI ](/tags/JNI/) [ 「Hello World」 ](/tags/「Hello-
World」/) [ Java ](/tags/Java/) [ C ](/tags/C/)

[ ** 上一篇： **  
Python 爬虫学习——收集「有趣」信息（8月16日更新）  ](/2014/06/24/learning-python-crawler-
gathering-interesting-information/)

[ ** 下一篇： **  
如何搭建免费静态博客——Hexo 与 GitHub 使用小记  ](/2014/06/21/how-to-build-a-free-static-blog-
hexo-and-github-notes/)

Please enable JavaScript to view the [ comments powered by Disqus.
](//disqus.com/?ref_noscript)

** Contents **

  1. 1\.  缘起 
  2. 2\.  何谓JNI？ 
  3. 3\.  HelloWorld 
  4. 4\.  More 

Tag Cloud

[ Android ](/tags/Android/) [ C ](/tags/C/) [ Django ](/tags/Django/) [ GHC
](/tags/GHC/) [ Git ](/tags/Git/) [ GitHub ](/tags/GitHub/) [ Hexo
](/tags/Hexo/) [ JNI ](/tags/JNI/) [ Jacman ](/tags/Jacman/) [ Java
](/tags/Java/) [ Markdown ](/tags/Markdown/) [ PIL ](/tags/PIL/) [ Pillow
](/tags/Pillow/) [ Python ](/tags/Python/) [ SAE ](/tags/SAE/) [ macro
](/tags/macro/) [ 「Hello World」 ](/tags/「Hello-World」/) [ 杂谈 ](/tags/杂谈/) [
混合编程 ](/tags/混合编程/) [ 爬虫 ](/tags/爬虫/) [ 网络传输协议 ](/tags/网络传输协议/)

Links

  * [ Logdown 博客 ](http://endless.logdown.com/)
  * [ CSDN 博客 ](http://blog.csdn.net/synapse7?viewmode=list)
  * [ GitHub ](https://github.com/EndlessCheng)

[ RSS ](/atom.xml)

[ ](https://github.com/EndlessCheng) [
](http://stackoverflow.com/users/3208881) [
](https://www.douban.com/people/52879216) [
](https://www.zhihu.com/people/endlesscheng) [
](https://plus.google.com/103441795113657293146?rel=author) [
](mailto:loli.con@qq.com)

Powered by [ hexo ](http://zespia.tw/hexo/) and Theme by [ Jacman
](https://github.com/wuchong/jacman) © 2015 [ 简言 ](http://jianyan.me/about)

![](/img/scrollup.png)

