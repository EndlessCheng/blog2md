#  [ Java 与 C++ 混合编程——JNI 学习小记 ](/2014/06/21/notes-on-java-and-c-programming-jni-blended-learning/)

By [ 简言 ](https://plus.google.com/103441795113657293146?rel=author)

Published Jun 21 2014 

** Contents **

  1. 1\.  缘起 
  2. 2\.  何谓JNI？ 
  3. 3\.  HelloWorld 
  4. 4\.  More 

##  缘起 

最近对 [ OpenJDK源码 ](http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/cf44386c8fe3/src/share/classes/java) 产生了很大的兴趣，而其中有较多的native方法，如 [ System.java ](http://hg.openjdk.java.net/jdk7/jdk7/jdk/file/cf44386c8fe3/src/share/classes/java/lang/System.java) 中的arraycopy方法（第482行）、setOut0方法（第247行）等。Google一下后发现这是Java Native Interface(JNI)，便花点时间学习了一下。 

##  何谓JNI？ 

JNI是Java平台中的一个强大特性。   
应用程序可以通过JNI把C/C++代码集成进Java程序中，这样开发者在利用Java平台强大功能的同时，又不必放弃对原有代码的投资。 

##  HelloWorld 

闲话少说，先看代码： 

新建一个class，名称为Algorithm 
    
    
    public class Algorithm {
    
    	static {
    
    		System.loadLibrary("Hello");
    
    	}
    
    	public static native void write(String msg);
    
    	public static void main(String[] args) {
    
    		write("Hello, 混合编程！");
    
    	}
    
    }  
  
---  
  
保存。 

打开cmd，cd到\src，执行 ` javah Algorithm ` （如果你的.java文件在某一package下的话，比如在\mjava\lang\里面，就执行 ` javah mjava.lang.Algorithm ` ），生成 ` Algorithm.h ` 文件，如下： 
    
    
    /* DO NOT EDIT THIS FILE - it is machine generated */
    
    #include <jni.h>
    
    /* Header for class Algorithm */
    
    #ifndef _Included_Algorithm
    
    #define _Included_Algorithm
    
    #ifdef __cplusplus
    
    extern "C" {
    
    #endif
    
    /*
    
     * Class:     Algorithm
    
     * Method:    write
    
     * Signature: (Ljava/lang/String;)V
    
     */
    
    JNIEXPORT void JNICALL Java_Algorithm_write
    
      (JNIEnv *, jclass, jstring);
    
    #ifdef __cplusplus
    
    }
    
    #endif
    
    #endif  
  
---  
  
对于Windows下的JDK来说，可以在JDK目录 ` \include\win32\jni_md.h ` 中找到如下定义 
    
    
    #define JNIEXPORT __declspec(dllexport)
    
    #define JNIIMPORT __declspec(dllimport)
    
    #define JNICALL __stdcall  
  
---  
  
其中 ` __declspec ` 用于指定所给定类型的实例的与Microsoft相关的存储方式。   
` dllexport ` 用来从dll中导出函数，数据或对象， ` dllimport ` 用来从dll导入函数，数据，或对象。   
这相当于定义了dll的接口，提供可被Java使用的C/C++函数，数据，或对象。   
` __stdcall ` 见 [ 百度百科 ](http://baike.baidu.com/view/1276580.htm) 。   
` JNIEnv ` ， ` jclass ` 和 ` jstring ` 的定义见 ` \include\jni.h ` ，也可以参考 [ jni详解 ](http://wenku.baidu.com/link?url=khOHgORmPEnOlIwZ_Zi7VBnueTNQcSp60EV-Grmiw12bgrLt0YT9rxTQq8PeOiBVecVewsW54EIBdKIt_DogruJUeqHaoYO9rFy8vDWs9Ce) 。 

随后打开VS2012，新建 Win32项目，名称随便：   
![](http://endless.qiniudn.com/blogjni01.png)   
应用程序类型选择DLL：   
![](http://endless.qiniudn.com/blogjni02.png)   
按 ` alt ` \+ ` F7 ` ，点击 ` 配置属性 ` \- ` VC++目录 ` ，如果你的JDK是64位的话，你的VS2012也应该是64位，此时做如下修改：（32位可以无视）   
![](http://endless.qiniudn.com/blogjni05.png)   
然后点击 ` 包含目录 ` \- ` 编辑 ` ：   
![](http://endless.qiniudn.com/blogjni04.png)   
点击文件夹图标，把 ` \include\ ` ， ` \include\win32\ ` 和 ` Algorithm.h ` 所在目录加进去。   
随后点击 ` 常规 ` ，把 ` 配置类型 ` 改为 ` 动态库(.dll) ` 。 

打开 ` <项目名>.cpp ` ，这里 ` <项目名> ` 是你自己输入的名字，输入如下代码：（函数名必须与Algorithm.h中声明的一致） 
    
    
    #include "stdafx.h"
    
    #include "Algorithm.h"
    
    #include <clocale>
    
    #include <cwchar>
    
    JNIEXPORT void JNICALL Java_Algorithm_write(JNIEnv * env, jclass obj, jstring jMsg)
    
    {
    
    	setlocale(LC_ALL, "Chinese-simplified"); // clocale
    
    	   wprintf(L"%ls", (wchar_t*)env->GetStringChars(jMsg, NULL));
    
    }  
  
---  
  
这里 ` setlocale ` 函数用来配置地域化信息， ` GetStringChars ` 函数将jstring转化成jchar数组并返回jchar*，这里jchar被定义为unsigned short，所以可以转化成wchar_t类型。 

按 ` F7 ` 。 

在你的项目文件夹中找到 ` <项目名>.dll ` 文件，复制，粘贴到你的工程下（直接在Eclipse中单击工程名然后 ` ctrl ` \+ ` V ` ），并重命名为 ` Hello.dll ` 。 

回到Eclipse，按下 ` Ctrl ` \+ ` F11 ` ，Well done！   
![](http://endless.qiniudn.com/blogjni06.png)

##  More 

自定义readLine()方法的实现，见 [ GitHub ](https://github.com/EndlessCheng/OpenJDK-7u4-analysis)

[ 混合编程 ](/tags/混合编程/) [ JNI ](/tags/JNI/) [ 「Hello World」 ](/tags/「Hello-World」/) [ Java ](/tags/Java/) [ C ](/tags/C/)
#### 原文：[http://jianyan.me/2014/06/21/notes-on-java-and-c-programming-jni-blended-learning/](http://jianyan.me/2014/06/21/notes-on-java-and-c-programming-jni-blended-learning/)